// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
const DELAY_BETWEEN_REQUESTS = 1500; // 1.5 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
const PRODUCTS_PER_PAGE = 24; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞–∫ –≤ Python –≤–µ—Ä—Å–∏–∏
const MAX_PAGES = 30; // –ú–∞–∫—Å–∏–º—É–º 30 —Å—Ç—Ä–∞–Ω–∏—Ü
const CACHE_DURATION = 1800; // 30 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
const CACHE_PREFIX = "wb_search_"; // –ü—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –∫—ç—à–∞
const PRODUCTS_CACHE_PREFIX = "wb_products_"; // –ü—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –∫—ç—à–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤

/**
 * –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–∑–∏—Ü–∏—é —Ç–æ–≤–∞—Ä–∞ –≤ –ø–æ–∏—Å–∫–æ–≤–æ–π –≤—ã–¥–∞—á–µ Wildberries
 * @param {string} articleNumber - –ê—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞
 * @param {string} searchQuery - –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
 * @return {string} –ü–æ–∑–∏—Ü–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
 * @customfunction
 */
function FIND_WB_POSITION(articleNumber, searchQuery) {
  if (!articleNumber || !searchQuery) {
    return "‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –∏ –∑–∞–ø—Ä–æ—Å";
  }

  try {
    articleNumber = articleNumber.toString();
    searchQuery = searchQuery.toString().trim().toLowerCase();
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç–æ–≤–∞—Ä–∞ (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∞)
    return findPositionInSearch(articleNumber, searchQuery);
    
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞: " + error.toString());
    return "‚ùå " + error.toString();
  }
}

/**
 * –ò—â–µ—Ç –ø–æ–∑–∏—Ü–∏—é —Ç–æ–≤–∞—Ä–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞
 * @param {string} articleNumber - –ê—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞
 * @param {string} searchQuery - –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
 * @return {string} –ü–æ–∑–∏—Ü–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
 */
function findPositionInSearch(articleNumber, searchQuery) {
  const cache = CacheService.getScriptCache();
  const cacheKey = CACHE_PREFIX + searchQuery;
  const productsCacheKey = PRODUCTS_CACHE_PREFIX + searchQuery;
  
  // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏–∑ –∫—ç—à–∞
  const cachedPosition = cache.get(cacheKey + "_" + articleNumber);
  if (cachedPosition) {
    Logger.log(`–ü–æ–∑–∏—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫—ç—à–µ –¥–ª—è –∞—Ä—Ç–∏–∫—É–ª–∞ ${articleNumber} –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchQuery}"`);
    return cachedPosition;
  }
  
  // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∏–∑ –∫—ç—à–∞
  const cachedProducts = cache.get(productsCacheKey);
  if (cachedProducts) {
    Logger.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è "${searchQuery}"`);
    const products = JSON.parse(cachedProducts);
    let position = 0;
    
    // –ò—â–µ–º –∞—Ä—Ç–∏–∫—É–ª –≤ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
    for (const id of products) {
      position++;
      if (id.toString() === articleNumber) {
        const result = `üéØ ${position}`;
        cache.put(cacheKey + "_" + articleNumber, result, CACHE_DURATION);
        return result;
      }
    }
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –∫—ç—à–µ
    return "–ù–µ—Ç –≤ –≤—ã–¥–∞—á–µ";
  }
  
  // –ï—Å–ª–∏ –≤ –∫—ç—à–µ –Ω–µ—Ç, –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫ API
  Logger.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Å API –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ "${searchQuery}"`);
  let position = 0;
  let productIds = []; // –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ ID —Ç–æ–≤–∞—Ä–æ–≤
  
  // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
  for (let page = 1; page <= MAX_PAGES; page++) {
    Logger.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${page}`);
    
    // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
    if (page > 1) {
      Utilities.sleep(DELAY_BETWEEN_REQUESTS);
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º URL
    const url = `https://search.wb.ru/exactmatch/ru/common/v4/search?appType=1&curr=rub&dest=-455460&page=${page}&query=${encodeURIComponent(searchQuery)}&resultset=catalog&sort=popular&spp=${PRODUCTS_PER_PAGE}&suppressSpellcheck=false`;
    
    // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
    const response = UrlFetchApp.fetch(url, {
      muteHttpExceptions: true,
      headers: {
        'Accept': '*/*',
        'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
        'Connection': 'keep-alive',
        'Origin': 'https://www.wildberries.ru',
        'Referer': 'https://www.wildberries.ru/catalog/0/search.aspx?sort=popular&search=' + encodeURIComponent(searchQuery),
        'Sec-Fetch-Dest': 'empty',
        'Sec-Fetch-Mode': 'cors',
        'Sec-Fetch-Site': 'cross-site',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
      }
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
    if (response.getResponseCode() !== 200) {
      throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ WB");
    }
    
    const data = JSON.parse(response.getContentText());
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º JSON –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (page === 1) {
      PropertiesService.getScriptProperties().setProperty(
        `search_response_${searchQuery.replace(/\s+/g, '_')}`,
        response.getContentText()
      );
    }
    
    if (!data.data || !data.data.products) {
      return "‚ùå –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤";
    }
    
    const products = data.data.products;
    
    // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—É—Å—Ç–∞—è, –∑–Ω–∞—á–∏—Ç –¥–æ—Å—Ç–∏–≥–ª–∏ –∫–æ–Ω—Ü–∞ –≤—ã–¥–∞—á–∏
    if (products.length === 0) {
      break;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ ID —Ç–æ–≤–∞—Ä–æ–≤
    productIds = productIds.concat(products.map(p => p.id));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    for (const product of products) {
      position++;
      if (product.id.toString() === articleNumber) {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö
        try {
          const salesUrl = `https://product-order-qnt.wildberries.ru/by-nm/?nm=${articleNumber}`;
          const salesResponse = UrlFetchApp.fetch(salesUrl, {
            muteHttpExceptions: true,
            headers: {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
            }
          });
          
          if (salesResponse.getResponseCode() === 200) {
            PropertiesService.getScriptProperties().setProperty(
              `sales_response_${articleNumber}`,
              salesResponse.getContentText()
            );
          }
        } catch (error) {
          Logger.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥–∞–∂–∞—Ö: " + error);
        }
        
        // –ö—ç—à–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ ID —Ç–æ–≤–∞—Ä–æ–≤
        try {
          cache.put(productsCacheKey, JSON.stringify(productIds), CACHE_DURATION);
        } catch (e) {
          Logger.log("–û—à–∏–±–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä): " + e);
        }
        
        const result = `üéØ ${position}`;
        cache.put(cacheKey + "_" + articleNumber, result, CACHE_DURATION);
        return result;
      }
    }
    
    // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ 3000 –ø–æ–∑–∏—Ü–∏–π, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è
    if (position >= 3000) {
      break;
    }
  }
  
  // –ö—ç—à–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ ID —Ç–æ–≤–∞—Ä–æ–≤ –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –Ω—É–∂–Ω—ã–π –∞—Ä—Ç–∏–∫—É–ª
  if (productIds.length > 0) {
    try {
      cache.put(productsCacheKey, JSON.stringify(productIds), CACHE_DURATION);
    } catch (e) {
      Logger.log("–û—à–∏–±–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä): " + e);
    }
  }
  
  return "–ù–µ—Ç –≤ –≤—ã–¥–∞—á–µ";
}

/**
 * –ò—â–µ—Ç –ø–æ–∑–∏—Ü–∏—é –∞—Ä—Ç–∏–∫—É–ª–∞ –≤ –º–∞—Å—Å–∏–≤–µ —Ç–æ–≤–∞—Ä–æ–≤
 * @param {Array} products - –ú–∞—Å—Å–∏–≤ —Ç–æ–≤–∞—Ä–æ–≤
 * @param {string} articleNumber - –ê—Ä—Ç–∏–∫—É–ª –¥–ª—è –ø–æ–∏—Å–∫–∞
 * @return {string|null} –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –∏–ª–∏ null
 */
function findArticlePosition(products, articleNumber) {
  for (let i = 0; i < products.length; i++) {
    if (products[i].id.toString() === articleNumber) {
      return `üéØ ${i + 1}`;
    }
  }
  return null;
}
